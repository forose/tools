"use strict";var e=require("vscode");function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n={}.toString,i=Array.isArray||function(e){return"[object Array]"==n.call(e)},o=i,s=i,r=function(e){return null!=e&&"object"==typeof e&&!1===o(e)},a=c;function c(e,t){if(!(this instanceof c))return"number"==typeof t?new c(e).fromIndex(t):new c(e,t);this.str=e||"",this.lineToIndex=function(e){for(var t=e.split("\n"),n=new Array(t.length),i=0,o=0,s=t.length;o<s;o++)n[o]=i,i+=t[o].length+1;return n}(this.str),t=t||{},this.origin=void 0===t.origin?1:t.origin}c.prototype.fromIndex=function(e){if(e<0||e>=this.str.length||isNaN(e))return null;var t=function(e,t){if(e>=t[t.length-1])return t.length-1;var n,i=0,o=t.length-2;for(;i<o;)if(e<t[n=i+(o-i>>1)])o=n-1;else{if(!(e>=t[n+1])){i=n;break}i=n+1}return i}(e,this.lineToIndex);return{line:t+this.origin,col:e-this.lineToIndex[t]+this.origin}},c.prototype.toIndex=function(e,t){if(void 0===t)return s(e)&&e.length>=2?this.toIndex(e[0],e[1]):r(e)&&"line"in e&&("col"in e||"column"in e)?this.toIndex(e.line,"col"in e?e.col:e.column):-1;if(isNaN(e)||isNaN(t))return-1;if(e-=this.origin,t-=this.origin,e>=0&&t>=0&&e<this.lineToIndex.length){var n=this.lineToIndex[e];if(t<(e===this.lineToIndex.length-1?this.str.length:this.lineToIndex[e+1])-n)return n+t}return-1};var l,g=t(a);function u(e){const t=/([.#])(-?[_a-zA-Z]+[_a-zA-Z0-9-]*)(?=[#.,()\s\[\]\^:*"'>=_a-zA-Z0-9-]*{[^}]*})/g,n=[],i=g(e,{origin:0});let o,s,r,a=0,c=0;for(;o=t.exec(e);)r=o.index,s=i.fromIndex(r),s&&(a=s.line,c=s.col+1),n.push({index:r,line:a,col:c,type:o[1],selector:o[2]});return n}!function(e){e.ID="#",e.CLASS="."}(l||(l={}));const d=new e.Position(0,0),f=new Map;class h{get isRemote(){return/^https?:\/\//i}get wordRange(){return/[_a-zA-Z0-9-]+/}get canComplete(){return/(id|class|className)\s*[=:]\s*(["'])(?:.(?!\2))*$/is}async fetch(t){try{const e=await fetch(t);if(e.ok)return e.text();throw new Error(e.statusText)}catch(n){e.window.showErrorMessage(`Fetching ${t} failed. ${n}`)}return""}async getRemote(e){let t=f.get(e);if(!t){t=u(await this.fetch(e)),f.set(e,t)}return t}async getLocal(t){const n=t.toString();let i=f.get(n);if(!i){i=u((await e.workspace.fs.readFile(t)).toString()),f.set(n,i)}return i}getRelativePattern(t,n){return new e.RelativePattern(t,n).pattern}async getStyles(t){const n=new Map,i=e.workspace.getWorkspaceFolder(t.uri),o=(s=t.uri,e.workspace.getConfiguration("css",s).get("styleSheets",[]));var s;for(const t of o)if(this.isRemote.test(t))n.set(t,await this.getRemote(t));else if(i){const o=await e.workspace.findFiles(this.getRelativePattern(i,t));for(const e of o)n.set(e.toString(),await this.getLocal(e))}return n.set(t.uri.toString(),u(t.getText())),n}async getCompletionMap(t,n){const i=new Map,o=await this.getStyles(t);for(const t of o.values())for(const o of t)if(o.type===n){const t=new e.CompletionItem(o.selector,o.type===l.ID?e.CompletionItemKind.Value:e.CompletionItemKind.Enum);i.set(o.selector,t)}return i}async getCompletionItems(e,t,n){const i=await this.getCompletionMap(e,n),o=e.getWordRangeAtPosition(t,this.wordRange),s=[];for(const e of i.values())e.range=o,s.push(e);return s}provideCompletionItems(t,n,i,o){const s=new e.Range(d,n),r=t.getText(s),a=this.canComplete.exec(r);return new Promise(((e,o)=>a&&!i.isCancellationRequested?e(this.getCompletionItems(t,n,"id"===a[1]?l.ID:l.CLASS)):o()))}async getDefinitions(t,n){const i=await this.getStyles(t),o=t.getWordRangeAtPosition(n,this.wordRange),s=t.getText(o),r=[];for(const t of i)this.isRemote.test(t[0])||t[1].filter((e=>e.selector===s)).forEach((n=>r.push(new e.Location(e.Uri.parse(t[0]),new e.Position(n.line,n.col)))));return r}provideDefinition(t,n,i){const o=new e.Range(d,n),s=t.getText(o),r=this.canComplete.exec(s);return new Promise(((e,o)=>r&&!i.isCancellationRequested?e(this.getDefinitions(t,n)):o()))}async validate(t){const n=/([^(\[{}\])\s]+)(?![^(\[{]*[}\])])/gi,i=/(class|className)\s*[=:]\s*(["'])(.*?)\2/gis,o=[],s=await this.getCompletionMap(t,l.CLASS),r=t.getText();let a,c,g,u,d,f;for(;a=i.exec(r);)for(c=i.lastIndex-a[3].length+a[3].indexOf(a[2]);g=n.exec(a[3]);)s.has(g[1])||(u=n.lastIndex+c,d=t.positionAt(u),f=t.positionAt(u-g[1].length),o.push(new e.Diagnostic(new e.Range(f,d),`CSS selector '${g[1]}' not found.`,e.DiagnosticSeverity.Warning)));return o}}exports.activate=function(t){const n=e.workspace.getConfiguration("css").get("enabledLanguages",["html"]),i=e.languages.createDiagnosticCollection(),o=new h;t.subscriptions.push(e.languages.registerCompletionItemProvider(n,o),e.languages.registerDefinitionProvider(n,o),e.workspace.onDidSaveTextDocument((e=>{return t=e.uri.toString(),void f.delete(t);var t})),e.workspace.onDidCloseTextDocument((e=>i.delete(e.uri))),e.workspace.onDidChangeTextDocument((e=>i.delete(e.document.uri))),e.commands.registerCommand("vscode-html-css.validate",(async()=>{const t=e.window.activeTextEditor;if(t){const e=t.document;n.includes(e.languageId)&&i.set(e.uri,await o.validate(e))}})),e.commands.registerCommand("vscode-html-css.clear",(()=>{f.clear()})))},exports.deactivate=function(){};
